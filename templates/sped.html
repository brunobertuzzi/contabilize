<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPED Fiscal - Contabilize</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<body data-empresa-selecionada="{{ 'true' if empresa_selecionada else 'false' }}">
    <!-- Loading Overlay -->
    <div id="competenciaLoadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Carregando dados...</div>
            <div class="loading-subtext">Atualizando relatórios para a nova competência</div>
        </div>
    </div>

    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <main class="main-content expanded" id="mainContent">
        <!-- Page Header -->
        <header class="page-header text-center position-relative">
            <i class="bi bi-file-earmark-zip page-icon" aria-hidden="true"></i>
            <h1 class="page-title">SPED Fiscal</h1>
            <p class="page-subtitle">Importe, analise e gerencie seus dados fiscais.</p>
        </header>

        <section class="container-fluid px-0">
            <!-- Card Seleção de Empresa -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-md-0">
                                <i class="bi bi-building me-2 text-primary-custom"></i>Empresa
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select" id="empresaSelect" aria-label="Selecionar empresa">
                                    <option value="">Selecione uma empresa</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.id }}" {% if empresa_selecionada and
                                        empresa_selecionada.id==empresa.id %}selected{% endif %}>
                                        {{ empresa.razao_social }} ({{ empresa.cnpj[:2] }}.{{ empresa.cnpj[2:5] }}.{{
                                        empresa.cnpj[5:8] }}/{{ empresa.cnpj[8:12] }}-{{ empresa.cnpj[12:] }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshEmpresas"
                                    title="Atualizar lista">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            {% if empresas|length == 0 %}
                            <small class="text-muted mt-2 d-block">
                                <i class="bi bi-info-circle me-1"></i>Nenhuma empresa cadastrada. Importe um arquivo
                                SPED para cadastrar automaticamente.
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Importar SPED -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-upload me-2 text-primary-custom"></i>Importar Arquivo SPED
                    </h5>
                    <form id="formSped" method="POST" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="file" class="form-control" id="arquivo_sped" name="arquivo_sped"
                                accept=".txt,.sped,.efd" required>
                            <button type="button" id="submitSped" class="btn btn-primary">
                                <i class="bi bi-upload me-2"></i>Importar
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" id="empresaImportInfo">
                            {% if empresa_selecionada %}
                            <i class="bi bi-info-circle me-1"></i>Importando para: <strong>{{
                                empresa_selecionada.razao_social }}</strong>. O arquivo deve pertencer a esta empresa.
                            {% else %}
                            <i class="bi bi-info-circle me-1"></i>Nenhuma empresa selecionada. A empresa será
                            identificada automaticamente pelo CNPJ do arquivo.
                            {% endif %}
                        </small>
                    </form>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs mb-0" id="spedTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos"
                        type="button" role="tab" aria-controls="produtos" aria-selected="true">
                        <i class="bi bi-box-seam me-2"></i>Produtos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vendas-tab" data-bs-toggle="tab" data-bs-target="#vendas" type="button"
                        role="tab" aria-controls="vendas" aria-selected="false">
                        <i class="bi bi-cart me-2"></i>Vendas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="relatorio-acumulador-tab" data-bs-toggle="tab"
                        data-bs-target="#relatorio-acumulador" type="button" role="tab"
                        aria-controls="relatorio-acumulador" aria-selected="false">
                        <i class="bi bi-calculator me-2"></i>Relatório por Acumulador
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="relatorio-cfop-tab" data-bs-toggle="tab"
                        data-bs-target="#relatorio-cfop" type="button" role="tab" aria-controls="relatorio-cfop"
                        aria-selected="false">
                        <i class="bi bi-bar-chart-line me-2"></i>Relatório por CFOP
                    </button>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content" id="spedTabsContent">
                <!-- Alerta quando não há empresa selecionada ou cadastrada -->


                <!-- Produtos Tab -->
                <div class="tab-pane fade show active" id="produtos" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-list-ul me-2 text-primary-custom"></i>Produtos Cadastrados
                                    </h5>
                                    <input type="text" id="searchProdutos" class="form-control w-auto ms-auto"
                                        style="min-width:200px; max-width:300px;" placeholder="Pesquisar produtos...">
                                </div>
                                <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
                                    <div class="btn-group flex-shrink-0" role="group">
                                        <input type="radio" class="btn-check" name="acumuladorFilter" id="todos"
                                            value="todos" checked>
                                        <label class="btn btn-outline-primary" for="todos">Todos</label>
                                        <input type="radio" class="btn-check" name="acumuladorFilter" id="cadastrados"
                                            value="cadastrados">
                                        <label class="btn btn-outline-primary" for="cadastrados">Com Acumulador</label>
                                        <input type="radio" class="btn-check" name="acumuladorFilter"
                                            id="naoCadastrados" value="naoCadastrados">
                                        <label class="btn btn-outline-primary" for="naoCadastrados">Sem
                                            Acumulador</label>
                                    </div>
                                    <button type="button" class="btn btn-secondary flex-shrink-0" data-bs-toggle="modal"
                                        data-bs-target="#acumuladoresModal">
                                        <i class="bi bi-gear me-2"></i>Acumuladores
                                    </button>
                                    <button type="button" class="btn btn-secondary flex-shrink-0" data-bs-toggle="modal"
                                        data-bs-target="#cfopsModal">
                                        <i class="bi bi-gear me-2"></i>CFOPs
                                    </button>
                                    <button type="button" class="btn btn-success flex-shrink-0" id="btnClassificarAuto"
                                        title="Classificar produtos automaticamente por NCM e nome">
                                        <i class="bi bi-magic me-2"></i>Classificar Automático
                                    </button>
                                    <button type="button" class="btn btn-warning flex-shrink-0"
                                        id="btnAnalisarInconsistencias"
                                        title="Analisar produtos similares com acumuladores diferentes">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Inconsistências
                                    </button>
                                </div>
                            </div>

                            <!-- Barra de Ações em Massa -->
                            <div id="bulkActionContainer" class="d-none p-3 mb-3 border rounded bg-light">
                                <div class="d-flex flex-wrap align-items-center gap-3">
                                    <span id="selectedCount" class="fw-semibold">0 produtos selecionados</span>
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <label for="bulkAcumuladorSelect" class="form-label mb-0 flex-shrink-0">Aplicar
                                            Acumulador:</label>
                                        <select class="form-select form-select-sm" id="bulkAcumuladorSelect">
                                            <option value="">Selecione...</option>
                                            {% for acumulador in acumuladores %}
                                            <option value="{{ acumulador.codigo }}">{{ acumulador.codigo }} - {{
                                                acumulador.descricao }}</option>
                                            {% endfor %}
                                        </select>
                                        <button id="applyBulkAction"
                                            class="btn btn-primary btn-sm flex-shrink-0">Aplicar</button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle" id="produtosTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-center" style="width: 1%;"><input class="form-check-input"
                                                    type="checkbox" id="selectAllProducts"></th>
                                            <th>Código</th>
                                            <th>Descrição</th>
                                            <th>Un.</th>
                                            <th>NCM</th>
                                            <th>Acumulador</th>
                                        </tr>
                                    </thead>
                                    <tbody id="produtosBody">
                                        {% for produto in produtos %}
                                        <tr class="{% if not produto.acumulador %}table-warning{% endif %}">
                                            <td><input class="form-check-input product-checkbox" type="checkbox"
                                                    data-codigo="{{ produto.codigo }}"></td>
                                            <td>{{ produto.codigo }}</td>
                                            <td>{{ produto.descricao }}</td>
                                            <td>{{ produto.unidade }}</td>
                                            <td>{{ produto.ncm }}</td>
                                            <td>
                                                <select class="form-select form-select-sm acumulador-select"
                                                    data-codigo="{{ produto.codigo }}">
                                                    <option value="">Selecione...</option>
                                                    {% for acumulador in acumuladores %}
                                                    <option value="{{ acumulador.codigo }}" {% if
                                                        produto.acumulador==acumulador.codigo %}selected{% endif %}>{{
                                                        acumulador.codigo }} - {{ acumulador.descricao }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Paginação -->
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Vendas Tab -->
                <div class="tab-pane fade" id="vendas" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-cart-check me-2 text-primary-custom"></i>Relatório de Vendas
                                </h5>
                                <div class="d-flex align-items-center">
                                    {% if empresa_selecionada %}
                                    <label for="competenciaVendasFilter"
                                        class="me-2 mb-0 flex-shrink-0 text-muted">Competência:</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" id="prevVendas"><i
                                                class="bi bi-chevron-left"></i></button>
                                        <select id="competenciaVendasFilter" class="form-select"></select>
                                        <button class="btn btn-outline-secondary" type="button" id="nextVendas"><i
                                                class="bi bi-chevron-right"></i></button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle" id="vendasTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendasBody"></tbody>
                                    <tfoot class="table-group-divider fw-bold bg-light"></tfoot>
                                </table>
                                <div id="vendasReportWarning" class="alert alert-warning d-none mt-3" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <span id="vendasReportWarningText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatório por Acumulador Tab -->
                <div class="tab-pane fade" id="relatorio-acumulador" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-calculator me-2 text-primary-custom"></i>Relatório por Acumulador
                                </h5>
                                <div class="d-flex align-items-center">
                                    {% if empresa_selecionada %}
                                    <label for="competenciaFilter"
                                        class="me-2 mb-0 flex-shrink-0 text-muted">Competência:</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" id="prevAcumulador"><i
                                                class="bi bi-chevron-left"></i></button>
                                        <select id="competenciaFilter" class="form-select"></select>
                                        <button class="btn btn-outline-secondary" type="button" id="nextAcumulador"><i
                                                class="bi bi-chevron-right"></i></button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle"
                                    id="relatorioAcumuladorTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 50%;">Acumulador</th>
                                            <th style="width: 30%;">Total de Vendas</th>
                                            <th style="width: 20%;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot class="table-group-divider fw-bold bg-light"></tfoot>
                                </table>
                                <div id="relatorioAcumuladorWarning" class="alert alert-warning d-none mt-3"
                                    role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <span id="relatorioAcumuladorWarningText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatório por CFOP Tab -->
                <div class="tab-pane fade" id="relatorio-cfop" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-bar-chart-line me-2 text-primary-custom"></i>Relatório por CFOP
                                </h5>
                                <div class="d-flex align-items-center">
                                    {% if empresa_selecionada %}
                                    <label for="competenciaCfopFilter"
                                        class="me-2 mb-0 flex-shrink-0 text-muted">Competência:</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" id="prevCfop"><i
                                                class="bi bi-chevron-left"></i></button>
                                        <select id="competenciaCfopFilter" class="form-select"></select>
                                        <button class="btn btn-outline-secondary" type="button" id="nextCfop"><i
                                                class="bi bi-chevron-right"></i></button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle" id="cfopTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>CFOP</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cfopBody"></tbody>
                                    <tfoot class="table-group-divider fw-bold bg-light"></tfoot>
                                </table>
                                <div id="cfopReportWarning" class="alert alert-warning d-none mt-3" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <span id="cfopReportWarningText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Acumuladores -->
    <div class="modal fade" id="acumuladoresModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Gerenciar Acumuladores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <button type="button" class="btn btn-primary" id="btnNovoAcumulador" data-bs-toggle="modal"
                            data-bs-target="#novoAcumuladorModal">
                            <i class="bi bi-plus-lg me-2"></i>Novo Acumulador
                        </button>
                        <input type="text" id="searchAcumuladores" class="form-control w-auto"
                            placeholder="Pesquisar acumuladores...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="acumuladoresTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição</th>
                                    <th>CFOP</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="acumuladoresBody">
                                {% for acumulador in acumuladores %}
                                <tr>
                                    <td>{{ acumulador.codigo }}</td>
                                    <td>{{ acumulador.descricao }}</td>
                                    <td>{{ acumulador.cfop }}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-warning edit-acumulador"
                                            data-codigo="{{ acumulador.codigo }}" title="Editar Acumulador">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-acumulador"
                                            data-codigo="{{ acumulador.codigo }}" title="Excluir Acumulador">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Acumulador -->
    <div class="modal fade" id="novoAcumuladorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="acumuladorModalTitle"><i class="bi bi-plus-lg me-2"></i>Novo Acumulador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="acumuladorForm">
                        <div class="mb-3">
                            <label for="acumuladorCodigo" class="form-label">Código</label>
                            <input type="text" class="form-control" id="acumuladorCodigo" required maxlength="10">
                        </div>
                        <div class="mb-3">
                            <label for="acumuladorDescricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="acumuladorDescricao" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="acumuladorCfop" class="form-label">CFOP</label>
                            <select class="form-select" id="acumuladorCfop" required>
                                <option value="">Selecione...</option>
                                {% for cfop in cfops %}
                                <option value="{{ cfop.codigo }}">{{ cfop.codigo }} - {{ cfop.descricao }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarAcumulador"
                        form="acumuladorForm">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal CFOPs -->
    <div class="modal fade" id="cfopsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Gerenciar CFOPs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <button type="button" class="btn btn-primary" id="btnNovoCfop" data-bs-toggle="modal"
                            data-bs-target="#novoCfopModal">
                            <i class="bi bi-plus-lg me-2"></i>Novo CFOP
                        </button>
                        <input type="text" id="searchCfops" class="form-control w-auto"
                            placeholder="Pesquisar CFOPs...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="cfopsTable"
                            style="table-layout: fixed;">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 70%;">CFOP</th>
                                    <th style="width: 30%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="cfopsBody">
                                {% for cfop in cfops %}
                                <tr>
                                    <td>{{ cfop.cfop }}</td>
                                    <td class="text-nowrap">
                                        <button type="button" class="btn btn-sm btn-warning edit-cfop align-middle"
                                            data-codigo="{{ cfop.cfop }}" data-id="{{ cfop.id }}" title="Editar CFOP">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-cfop align-middle"
                                            data-codigo="{{ cfop.cfop }}" data-id="{{ cfop.id }}" title="Excluir CFOP">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo CFOP -->
    <div class="modal fade" id="novoCfopModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cfopModalTitle"><i class="bi bi-plus-lg me-2"></i>Novo CFOP</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="cfopForm" novalidate>
                        <input type="hidden" id="cfopOriginal" value="">
                        <div class="mb-3">
                            <label for="cfopCodigo" class="form-label">CFOP</label>
                            <input type="text" class="form-control" id="cfopCodigo" required pattern="[1-7][0-9]{3}"
                                maxlength="4">
                            <div class="invalid-feedback">CFOP inválido. Digite 4 dígitos começando com 1, 2, 3, 5, 6 ou
                                7.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveCfopButton">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Inconsistências -->
    <div class="modal fade" id="inconsistenciasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Análise de Inconsistências
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Produtos com NCM igual (ou similar) E descrições similares (≥80%) mas acumuladores diferentes.
                        Isso indica classificações inconsistentes que precisam de revisão.
                    </p>
                    <div id="inconsistenciasLoading" class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Analisando...</span>
                        </div>
                        <p class="mt-2 text-muted">Analisando produtos...</p>
                    </div>
                    <div id="inconsistenciasResultado" class="d-none">
                        <div id="inconsistenciasAlerta" class="alert d-none"></div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span id="inconsistenciasContador" class="text-muted"></span>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Código</th>
                                        <th>Descrição</th>
                                        <th>NCM</th>
                                        <th>Acumulador</th>
                                        <th class="text-center">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="inconsistenciasBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Classificação Automática -->
    <div class="modal fade" id="classificacaoAutoModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-magic me-2"></i>Classificação Automática</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Sugestões de acumuladores baseadas em produtos já classificados com NCM e descrição similares.
                        Revise e aprove ou rejeite cada sugestão.
                    </p>
                    <div id="classificacaoLoading" class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Analisando...</span>
                        </div>
                        <p class="mt-2 text-muted">Analisando produtos sem acumulador...</p>
                    </div>
                    <div id="classificacaoResultado" class="d-none">
                        <div id="classificacaoAlerta" class="alert d-none"></div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span id="classificacaoContador" class="text-muted"></span>
                            <div>
                                <button type="button" class="btn btn-success btn-sm" id="btnAprovarTodas">
                                    <i class="bi bi-check-all me-1"></i>Aprovar Todas
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Código</th>
                                        <th>Descrição</th>
                                        <th>NCM</th>
                                        <th>Acumulador</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="classificacaoBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="toastContainer"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
        // Variável global para indicar se há empresa selecionada
        window.empresaSelecionada = document.body.dataset.empresaSelecionada === 'true';
    </script>
    <script src="/static/js/sped.js"></script>

    <script>
        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        function toggleSidebar(expand) {
            if (expand) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
            } else {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            }
        }

        if (window.innerWidth > 768) {
            sidebar.addEventListener('mouseenter', () => toggleSidebar(true));
            sidebar.addEventListener('mouseleave', () => toggleSidebar(false));
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (window.innerWidth <= 768) {
                toggleSidebar(false);
            }
        });

        // Gerenciamento de seleção de empresa
        const empresaSelect = document.getElementById('empresaSelect');
        const refreshEmpresas = document.getElementById('refreshEmpresas');
        const empresaImportInfo = document.getElementById('empresaImportInfo');

        if (empresaSelect) {
            empresaSelect.addEventListener('change', async function () {
                const empresaId = this.value;

                try {
                    const response = await fetch(`/empresas/selecionar/${empresaId || 0}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Atualiza a mensagem de importação (se o elemento existir)
                        if (empresaImportInfo) {
                            if (data.empresa) {
                                empresaImportInfo.innerHTML = `<i class="bi bi-info-circle me-1"></i>Importando para: <strong>${data.empresa.razao_social}</strong>. O arquivo deve pertencer a esta empresa.`;
                            } else {
                                empresaImportInfo.innerHTML = `<i class="bi bi-info-circle me-1"></i>Nenhuma empresa selecionada. A empresa será identificada automaticamente pelo CNPJ do arquivo.`;
                            }
                        }

                        // Recarrega a página para atualizar os dados filtrados
                        window.location.reload();
                    } else {
                        showToast(data.error || 'Erro ao selecionar empresa', 'danger');
                    }
                } catch (error) {
                    console.error('Erro ao selecionar empresa:', error);
                    showToast('Erro ao conectar com o servidor', 'danger');
                }
            });
        }

        if (refreshEmpresas) {
            refreshEmpresas.addEventListener('click', () => {
                window.location.reload();
            });
        }
    </script>
</body>

</html>